 <!--  put in a key for the graph, only grabbing FeatureCollection 
 		put in a click function -->

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<script type="text/javascript" src="d3.min.js"></script>
	<script src="http://d3js.org/topojson.v0.min.js"></script>
	<link type="text/css" rel="stylesheet" href="mapp.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
	<script>
	$(document).ready(function() {
		$("select#selectBar").change(function() {
			var thisvalue = $("#selectBar option:selected").text();
			$('a#pagetitle').text(thisvalue);
		});
	});
	</script>
</head>
<body onload="loadImage('Fertility.json')">
	<a id="pagetitle"> Fertility </a>
	<div id="interactive_panel">
		<div id="interactive_menu">

		</div> <!-- circular_interactive_menu -->
		<div id="option_menu">
			<select id="selectBar" onChange="changeDataset(this.options[this.selectedIndex].innerHTML);"></select>
			<select id="selectBarColor" onChange="changeAttribute(this.options[this.selectedIndex].innerHTML)"></select>
		</div> <!-- option_menu -->

		<!-- grab text from d3js and display them here -->

	</div> <!--interactive_panel -->	
	<br/>
	<div id="tooltip"></div>
	<script id="map">
	
		d3.csv("filelist.csv", function(data) {
			d3.select("#selectBar").selectAll("option")
							.data(data)
							.enter()
							.append("option")
							.attr("id", function(d,i) {
								return ("option" + i)
							})
							.text(function(d) {
								return d.FileNames;
							});
		});
	
		d3.csv("Attributes.csv", function(data) {
			d3.select("#selectBarColor").selectAll("option")
							.data(data)
							.enter()
							.append("option")
							.attr("id", function(d,i) {
								return ("option" + i)
							})
							.text(function(d) {
								return d.Attribute;
							});
		});
	
		var json = d3.json("World Population.json"); 
	
		var tooltip = d3.select('text')
							.append('div')
							.attr('class', 'tooltip');
	
		var currentjson = "";
	
		function loadImage(dataset) {
		
			currentjson = dataset;
			
			var margin = {
    			top: 20,
    			right: 10,
    			bottom: 30,
    			left: 50
			};
		
			var h = window.innerHeight * .03 - margin.top - margin.bottom; 
			var w = window.innerWidth * 1 - margin.left - margin.right;
			var padding = 50;
			var countryattr = [];
			var color = [];
			console.log("before accessing json: " + json);
		
			var svg = d3.select("body").append("svg")
				//a box to contain the map
				.attr("id", "mySVG")
    			.attr("width", w)
    			.attr("height", h)
    			.style("border", "2px solid black");
				//accesses the json and creates a projection
			var map = d3.json(dataset, function (json) {
    			// create a first guess for the projection
    			var center = d3.geo.centroid(json);
    			var scale = 140;
    			var offset = [w / 2 + (margin.top*8), h / 2 + (margin.top*8)];
    			var projection = d3.geo.mercator().scale(scale).center(center)
        			.translate(offset);

    			// create the path
    			var path = d3.geo.path().projection(projection);
    			
    			// using the path to determine the bounds of the current
    			// bounds of the current map and use these to determine
    			// better values for scale and translation
    			var bounds = path.bounds(json);
    			var hscale = scale*w / (bounds[1][0] + bounds[0][0]);
    			var vscale = scale*w / (bounds[1][1] - bounds[0][1]);
    			var scale = (hscale < vscale) ? hscale : vscale;
    			var offset = [w - (bounds[0][0] + bounds[1][0])/2, 
    									h - (bounds[0][1] - bounds[1][1])/2];
    			//NOTE: FIX OFFSET BUT I THINK ITS PERMANENT NOW

    			// new projection
    			projection = d3.geo.mercator().center(center)
    							.scale(scale).translate(offset);
    			path = path.projection(projection);


    			for (var i = 0; i < json.features.length; i++) {
	 				countryattr[i] = json.features[i].properties.GDPpcap;
	 			}
			
    			//sets a quantized scale based on the automatically-calculated data range
				var colorScale = d3.scale.quantize()
    							.range(['#ffffcc','#a1dab4',
									'#41b6c4','#225ea8'])
    							.domain([d3.min(countryattr), d3.max(countryattr)]);
				//links the data variable to the color scale
				for (var i = 0; i < json.features.length; i++) {
	 				color[i] = colorScale(countryattr[i]);
	 			}

	 			var lock;
	 		
				//makes the map
				svg.selectAll("path")
    				.data(json.features)
    				.enter()
    				.append("path")
    				.attr("d", d3.geo.path().projection(projection))
					.attr("stroke", "black")
					.attr("fill", function(json, i) {	
				
						if (countryattr[i] > 0) { 
							return color[i];
						}
						else {
							return "grey";}
						}) //missing data is grey
													
    				.on("mouseover", function(d) {
    					d3.select(this).style('stroke-width', '2px')
    									.style('fill-opacity', 2);
    					console.log(d3.select(this));
    					
    					var tooltipDiv = document.getElementById('tooltip');
    					// <! -- look up innerHTML in API -->
    					tooltipDiv.innerHTML = d.properties.CNTRY_NAME + "<br />" + 
    						"Total Population: " + d.properties.TotPop + "<br />";
    					tooltipDiv.style.display = "block";
    				})
    			
    				.on("click", function(d) {
	 					d3.select(this).style('stroke-width', '1px')
	 							.style('fill-opacity', 1);
	 					console.log("item clicked");
	 					lock = true;
	 					var tooltipDiv = document.getElementById('tooltip');
	 					tooltipDiv.style.display = "block";
	 				})

					.on("mouseout", function(d) {
						if (lock == true) {
							d3.select(this).style('stroke-width', '1px')
	 							.style('fill-opacity', 1);
	 						console.log("item clicked");
	 						lock = true;
	 						var tooltipDiv = document.getElementById('tooltip');
	 						tooltipDiv.style.display = "block";
						}
						else {
	 						d3.select(this).style('stroke-width', '1px')
	 								.style('fill-opacity', 1);
	 						tooltip.style('visibility', 'hidden');
	 					
	 						 var tooltipDiv = document.getElementById('tooltip');
	 		             	  tooltipDiv.style.display = "none";
						}
	 				})
			});
		}// loadImage()
			
		function changeDataset(dataset) {	
			console.log("current dataset: " + currentjson);
			d3.selectAll("path")
				.transition()
				.duration(750)
				.attr("height", 0)
				setTimeout(function() {
					d3.selectAll("body")
						.transition()
						.duration(200)
						setTimeout(function() {
							d3.selectAll("#mySVG").remove();
							loadImage(dataset + ".json"); 
							d3.selectAll("#map").transition().duration(200).style("opacity", 1);
							}, 450);
					}, 750);
			console.log("done");
		}// changeDataset()
	
		function changeAttribute(attribute) {
			var countryattr = [];
			var color = [];
			//grab data from current dataset
			var dataset = currentjson;
		
			var map = d3.json(dataset, function (json) {
				console.log(json)
				for (var i = 0; i < json.features.length; i++) {
					countryattr[i] = json.features[i].properties[attribute];
					console.log([i]);
			}
	
			//sets a quantized scale based on the automatically-calculated data range
			var colorScale = d3.scale.quantize()
						.range(['#ffffcc','#a1dab4',
							'#41b6c4','#225ea8'])
						.domain([d3.min(countryattr), d3.max(countryattr)]);
			//links the data variable to the color scale
			for (var i = 0; i < json.features.length; i++) {
				color[i] = colorScale(countryattr[i]);
			}
		
		
			console.log(attribute);
			d3.selectAll("path")
				.transition()
				.duration(750)
				.attr("height", 0)
				setTimeout(function() {
					d3.selectAll("body")
						.transition()
						.duration(200)
						setTimeout(function() {
							d3.selectAll("path")
								.attr("fill", function(json, i) {	
				
									if (countryattr[i] > 0) { 
										return color[i];
									}
									else {
										return "grey";
									}
								}) //missing data is grey
						
    							.on("mouseover", function(d) {
    								d3.select(this).style('stroke-width', '2px')
    								.style('fill-opacity', 2);
    								console.log(d3.select(this));
    					
    								var tooltipDiv = document.getElementById('tooltip');

    								tooltipDiv.innerHTML = d.properties.CNTRY_NAME + "<br />" +
    								"Total Population: " + d.properties.TotPop + "<br />" +
    								attribute + ": " + d.properties[attribute];
    								tooltipDiv.style.display = "block";
    							})
    				
								.on("mouseout", function(d) {
	 								d3.select(this).style('stroke-width', '1px')
	 								.style('fill-opacity', 1);
	 								tooltip.style('visibility', 'hidden');
	 					
	 					 			var tooltipDiv = document.getElementById('tooltip');
	 		               			tooltipDiv.style.display = "none";
	 							})
						}, 450);
				}, 750);
			});
   			console.log("done");
		}// changeAttribute()
			
		var dropDown = document.getElementById("selectBar");
		var dropDownColor = document.getElementById("selectBarColor");
			
	</script>
	<div id="credit">
		<p class="date"> August 20, 2015 </p>
		<p class="by">by</p>
		<p class="id"> Amanda Hinchman-Dominguez, Student, Grinnell College </p>
	</div> 
</body>
</html>